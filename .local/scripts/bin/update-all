#!/bin/bash

mac_key() {
    eval `ssh-agent -s`
    ssh-add -K ~/.ssh/imac
}

usage() {
    echo "Usage: $0 [OPTION...] " 1>&2
    echo "-k Add ssh key" 1>&2
}

exit_abnormal() { # Function: Exit with error.
    usage
    exit 1
}

flag1=false

#https://www.computerhope.com/unix/bash/getopts.htm
while getopts "k" options; do # Loop: Get the next option;
    # use silent error checking;
    case "${options}" in #
    k)                   # If the option is n,
        flag1=true
        ;;
    :) # If expected argument omitted: # there are no expected arguments so far
        echo "Error: -${OPTARG} requires an argument."
        exit_abnormal # Exit abnormally.
        ;;
    *)                # If unknown (any other) option:
        exit_abnormal # Exit abnormally.
        ;;
    ?)
        exit_abnormal
        ;;
    esac
done

if $flag1; then
    mac_key
fi


# Define a function to recursively search for git repositories
function git_pull_recursive {
    # Loop over all files and directories in the current directory
    for file in *; do
        # Check if the file is a directory
        if [ -d "$file" ]; then
            # Check if the directory is a git repository
            if [ -d "$file/.git" ]; then
                # Change into the directory and perform a git pull
                cd "$file"
                printf "Pulling $file\n"
                git pull
                cd ..
            else
                # Recursively search this directory for git repositories
                cd "$file"
                git_pull_recursive
                cd ..
            fi
        fi
    done
}

# Call the function to start the recursive search
git_pull_recursive

